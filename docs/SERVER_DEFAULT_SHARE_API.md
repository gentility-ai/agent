# Server API Specification: Default Share Endpoint

**Status:** Required for filesystem mount functionality
**Affected Component:** Agent filesystem integration (`AgentFS`)
**Audience:** API Team

---

## Overview

The Gentility agent requires a WebSocket command to retrieve the organization's default filesystem repository configuration. This enables the agent to automatically provide users with org-scoped shared context repositories without requiring manual configuration.

## Use Case

When a user runs `agent open .` without specifying a repository name, the agent needs to:

1. Query the server for the organization's default repository
2. Clone that repository locally (if not already present)
3. Mount it at the user's specified path

This allows seamless access to shared organizational context across all team members.

---

## WebSocket Command Specification

### Command Name

```
get_default_share
```

### Request Format

The agent sends a WebSocket message to the server with this structure:

```json
{
  "type": "command",
  "command": "get_default_share",
  "request_id": "abc123",
  "params": {}
}
```

**Fields:**
- `type`: Always `"command"`
- `command`: Always `"get_default_share"`
- `request_id`: Unique identifier for tracking this request (generated by agent)
- `params`: Empty object (no parameters required)

**Authentication:** The WebSocket connection is already authenticated via OAuth token or machine key (sent during connection handshake), so the agent's organization is already known to the server.

---

## Response Format

### Success Response

```json
{
  "type": "response",
  "request_id": "abc123",
  "result": {
    "org_slug": "acme",
    "git_url": "git@github.com:acme/shared-context.git",
    "name": "shared"
  }
}
```

**Fields:**
- `type`: Always `"response"`
- `request_id`: Matches the request ID from the command
- `result`: Object containing repository configuration
  - `org_slug` (string, required): Organization identifier (e.g., `"acme"`)
  - `git_url` (string, required): Git clone URL for the default repository
  - `name` (string, required): Repository name within org (typically `"shared"`)

**Repository Naming Convention:**
The agent will store this repository locally as `{org_slug}/{name}`, for example:
- `acme/shared` - Organization-wide shared context
- `acme/james` - Individual user's personal context (future feature)

---

### Error Response

If the organization doesn't have a default repository configured:

```json
{
  "type": "error",
  "request_id": "abc123",
  "error": "no_default_share",
  "message": "No default repository configured for this organization"
}
```

**Error codes:**
- `no_default_share` - Organization has no default repository configured
- `unauthorized` - Agent doesn't have permission to access default share
- `internal_error` - Server-side error retrieving configuration

---

## Git URL Format

The `git_url` field should support standard git clone formats:

### SSH (Recommended)
```
git@github.com:acme/shared-context.git
git@gitlab.com:acme/team-context.git
```

### HTTPS
```
https://github.com/acme/shared-context.git
https://gitlab.com/acme/team-context.git
```

**Authentication:**
- **SSH URLs**: Agent relies on user's configured SSH keys (`~/.ssh/`)
- **HTTPS URLs**: Agent may need credential helper or token embedding

**Recommendation:** Use SSH URLs for simplicity. Users can configure their SSH keys once, and all git operations will work seamlessly.

---

## Agent Behavior Flow

Here's what happens when a user runs `agent open .`:

```
1. User executes: agent open .

2. Agent CLI sends RPC to daemon: fs.open with path="."

3. Agent daemon checks if "default" repo exists locally at:
   ~/.config/gentility/fs/repos/{org_slug}/{name}/

4. If NOT found locally:
   a. Agent sends WebSocket command: get_default_share
   b. Server responds with org_slug, git_url, name
   c. Agent executes: jj git clone {git_url} ~/.config/gentility/fs/repos/{org_slug}/{name}
   d. Repository is now available locally

5. Agent creates a workspace and mounts it:
   a. Create workspace: jj workspace add
   b. Spawn NFS server for the workspace
   c. Mount via NFS at user's specified path
   d. Start file watching and sync

6. User can now edit files in current directory
   - Changes auto-commit to Jujutsu
   - Changes sync across all mounts of same repo
```

---

## Implementation Notes for API Team

### 1. Data Source

You'll need to store/retrieve this configuration per organization:

```sql
-- Example schema (adjust to your database)
CREATE TABLE organization_default_repos (
    org_id UUID PRIMARY KEY,
    git_url TEXT NOT NULL,
    name TEXT DEFAULT 'shared',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

Or if using a configuration service, store as JSON:

```json
{
  "organizations": {
    "acme": {
      "default_repo": {
        "git_url": "git@github.com:acme/shared-context.git",
        "name": "shared"
      }
    }
  }
}
```

### 2. Organization Detection

Extract the organization from the authenticated WebSocket connection:

- **OAuth token**: Decode token to get user → user's organization
- **Machine key**: Machine key is already associated with an organization

### 3. Repository Initialization

**Important:** The server should **not** create the git repository automatically. The repository must already exist at the provided `git_url`. The agent will clone it.

**Setup Steps:**
1. Create a git repository (GitHub, GitLab, etc.) for the organization
2. Initialize it with Jujutsu-compatible structure (or empty - Jujutsu handles this)
3. Configure the `git_url` in your database/config for that organization
4. Agent will clone it on first use

### 4. Security Considerations

- ✅ **Authentication**: Already handled by WebSocket connection auth
- ✅ **Authorization**: Ensure agent belongs to organization before returning repo URL
- ⚠️ **Repository Access**: Ensure users have git access to the returned URL
  - For SSH URLs: Users must have SSH keys configured for the git host
  - For HTTPS URLs: Consider if credentials need to be managed

### 5. Future Enhancements (FYI)

We may add support for:
- Multiple default repositories per org (e.g., `shared`, `engineering`, `sales`)
- User-specific repositories (e.g., `acme/james` for personal context)
- Repository access control (who can read/write)

For now, just implement single org-wide default.

---

## Testing

### Test Cases for API Team

1. **Valid Request - Org Has Default Repo**
   ```
   Request: get_default_share (authenticated as acme org)
   Expected: Returns git_url for acme's default repo
   ```

2. **Valid Request - No Default Configured**
   ```
   Request: get_default_share (authenticated as org without default)
   Expected: Returns error: "no_default_share"
   ```

3. **Unauthorized**
   ```
   Request: get_default_share (invalid/expired token)
   Expected: Returns error: "unauthorized"
   ```

### Manual Testing with Agent

Once implemented, test with:

```bash
# 1. Start agent
./agent run

# 2. In another terminal, try to open default repo
./agent open ~/test-mount

# Expected behavior:
# - Agent queries get_default_share
# - Agent clones the repository
# - Agent mounts it at ~/test-mount
# - User sees files from the default repo in ~/test-mount
```

---

## Example Complete Interaction

**Agent → Server:**
```json
{
  "type": "command",
  "command": "get_default_share",
  "request_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Server → Agent:**
```json
{
  "type": "response",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "result": {
    "org_slug": "acme",
    "git_url": "git@github.com:acme/shared-context.git",
    "name": "shared"
  }
}
```

**Agent Action:**
```bash
# Agent executes internally:
jj git clone git@github.com:acme/shared-context.git \
  ~/.config/gentility/fs/repos/acme/shared

# Then creates workspace and mounts it
```

---

## Reference Implementation (Agent Side)

For reference, here's how the agent currently handles this (placeholder implementation):

**File:** `src/agent.cr` (lines 1002-1009)

```crystal
when "get_default_share"
  # Return configured default share info
  # For now, return a placeholder - server will need to provide this
  {
    "org_slug" => "default",
    "git_url" => "", # Server should provide this
    "name" => "shared"
  }
```

**File:** `src/agent/fs/commands/open.cr` (lines 95-116)

```crystal
private def get_default_repo_name : String
  # Query agent's websocket connection for default share
  # This will be implemented via agent's WebSocket query
  # For now, return hardcoded default
  "default/shared"
end

private def import_default_repo(repo_name : String)
  # Query server for git URL
  # Clone using jj git clone
  # This requires server integration - stub for now
  raise "Repository #{repo_name} not found locally and server import not yet implemented"
end
```

---

## Questions?

Contact the agent team for clarification:
- Agent implementation details
- Jujutsu version control specifics
- NFS mount behavior
- WebSocket protocol questions

---

**Document Version:** 1.0
**Last Updated:** 2025-10-28
**Related PR:** https://github.com/gentility-ai/agent/pull/1
